## NegotiatedAi – Developer Setup Instructions

### Overview
End-to-end guide to set up the mobile app (Expo), AWS AppSync GraphQL, Cognito auth, and the Assistant Lambda/API for local development and testing.

### Prerequisites
- Node.js 18+ and npm
- PowerShell 7+ (pwsh) on Windows/macOS/Linux
- AWS CLI v2 configured with an IAM profile that has permissions for AppSync, Lambda, API Gateway, IAM, DynamoDB, and Secrets Manager
- An existing AWS account and region (default examples use `us-east-1`)
- Expo Go app on your device or an Android emulator / iOS simulator

### Repository Layout Essentials
- `mobile/` – Expo app entrypoints and code
- `schema.graphql` – AppSync GraphQL schema
- `scripts/agent/` – Assistant Lambda (`assistant.js`) and deployment script (`deploy.ps1`)
- `scripts/push-schema.js` – Push schema to AppSync (requires `APPSYNC_API_ID`)
- `_docs/appsync/resolvers/` – Example VTL resolvers for `UserProfile`
- `_docs/infra/user_profiles_table.yaml` – CloudFormation for a `UserProfiles` table (optional)

---

### 1) Configure AWS CLI
Set your profile and region for the session.

```powershell
$env:AWS_PROFILE = 'my-aws-profile'
$env:AWS_DEFAULT_REGION = 'us-east-1'   # default region for this project
```

Verify:

```powershell
aws sts get-caller-identity
```

---

### 2) AppSync API and Schema
You need an AppSync GraphQL API. Create one (via Console, CDK, or Amplify) and capture its API ID and GraphQL endpoint.

- API ID example: `ke2mzdeb7bgolo7gf7bjyfxa5i`
- GraphQL endpoint example: `https://<appsync-api-id>.appsync-api.us-east-1.amazonaws.com/graphql`

Push the schema in this repo to your API:

```powershell
# From repo root
node scripts/push-schema.js --api-id=<APPSYNC_API_ID>
```

Notes:
- Configure AppSync authentication: Default auth = Cognito User Pools (use your own User Pool). Add AWS_IAM as an additional provider (used by the Assistant Lambda via SigV4).
- The repo uses a custom schema (no Amplify codegen). Resolvers are assumed generated or attached as needed via console/CDK.
- For `UserProfile` examples, see `_docs/appsync/README.md` and attach example VTLs for `Query.getUserProfile` and `Mutation.updateUserProfile` if you are not using autogenerated resolvers.

Field-level auth tip for message metadata (if you see nulls):
- See `_docs/2_INPROCESS/Option2_AppSyncMetadataPermissionsFix.md` for approaches to allow reading `Message.metadata`.

---

### 3) Cognito Authentication
Create your own resources manually in your AWS account:
- Cognito User Pool + App Client (no secret)
- Cognito Identity Pool (federation to User Pool)

Capture values:
- `AWS_REGION` (use `us-east-1` unless you need a different region)
- `COGNITO_USER_POOL_ID`
- `COGNITO_CLIENT_ID`
- `COGNITO_IDENTITY_POOL_ID`

Update `mobile/.env` with your values.

---

### 4) Mobile App Environment
Create `mobile/.env` using the following template:

```env
AWS_REGION=us-east-1
COGNITO_USER_POOL_ID=us-east-1_xxxxx
COGNITO_CLIENT_ID=xxxxxxxxxxxxxxxxxxxxxx
COGNITO_IDENTITY_POOL_ID=us-east-1:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
APPSYNC_ENDPOINT=https://<appsync-api-id>.appsync-api.us-east-1.amazonaws.com/graphql

# Product flags (common)
ASSISTANT_ENABLED=true
ASSISTANT_ENDPOINT=https://<your-api-id>.execute-api.us-east-1.amazonaws.com/prod
ENABLE_CONVERSATION_LIST_UX=true
ENABLE_AUTH_UX=true
```

Install and run the app:

```bash
cd mobile
npm install
npx expo start
```

Notes:
- `mobile/app.config.ts` loads `.env` via `dotenv/config` and publishes to `Constants.expoConfig.extra`.
- `mobile/src/aws.ts` reads `extra` to `Amplify.configure` for Cognito and AppSync.
- Push notifications work on a dev client or standalone build; Expo Go skips remote registration.

---

### 5) Assistant Lambda + HTTP API
The Assistant is a single Lambda that reads recent messages and posts a reply as `assistant-bot`. Optional OpenAI integration can enrich replies and metadata.

Deploy via PowerShell (idempotent):

```powershell
pwsh -File scripts/agent/deploy.ps1 `
  -Profile my-aws-profile `
  -Region us-east-1 `
  -AppSyncApiId <APPSYNC_API_ID> `
  -AppSyncEndpoint https://<appsync-api-id>.appsync-api.us-east-1.amazonaws.com/graphql `
  -EnableOpenAI `
  -EnableDecisions `
  -EnableRecipes `
  -DebugLogs
```

Outputs will include the HTTP API base URL. Set that as `ASSISTANT_ENDPOINT` in `mobile/.env`.

OpenAI configuration options:
- Inline: pass `-OpenAIApiKey <key>` to set `OPENAI_API_KEY`.
- Secrets Manager: pass `-OpenAISecretArn arn:aws:secretsmanager:<region>:<account-id>:secret:<name>`.
- Default model is `gpt-4o-mini` (overridable via `-OpenAIModel`).

Feature flags (Lambda env):
- `ASSISTANT_OPENAI_ENABLED`, `ASSISTANT_RECIPE_ENABLED`, `ASSISTANT_DECISIONS_ENABLED`, `ASSISTANT_PRIORITY_ENABLED`, `ASSISTANT_CONFLICTS_ENABLED`, `ASSISTANT_CALENDAR_CONFLICTS_ENABLED`

Feature flags (mobile `.env` → `extra`):
- `ASSISTANT_ENABLED`, `ASSISTANT_ENDPOINT`, `ASSISTANT_DECISIONS_ENABLED`, `ASSISTANT_RECIPE_ENABLED`, `ASSISTANT_PRIORITY_ENABLED`, `ASSISTANT_CONFLICTS_ENABLED`, `ASSISTANT_CALENDAR_ENABLED`, `ASSISTANT_CALENDAR_READ_ENABLED`

---

### 6) DynamoDB Tables
AppSync manages core tables for Conversations/Messages/Users when generated resolvers are used. If you need a dedicated `UserProfiles` table for profile resolvers:

- CloudFormation template: `_docs/infra/user_profiles_table.yaml`

Deploy (one example):

```bash
aws cloudformation deploy \
  --stack-name user-profiles \
  --template-file _docs/infra/user_profiles_table.yaml \
  --parameter-overrides TableName=UserProfiles \
  --capabilities CAPABILITY_IAM
```

Attach resolvers per `_docs/appsync/README.md`.

---

### 7) Notifications (Advanced/Optional)
A minimal Lambda exists under `scripts/notify/notifyOnMessage/` to send Expo push notifications. Provide env vars:
- `USERS_TABLE` – table with user `id` and `pushToken`
- `PARTICIPANTS_TABLE` – table with `conversationId` and `userId`

This Lambda scans conversation participants (excluding sender) and sends push notifications via Expo Push API. Treat this as an advanced/optional component for now (no CI/CD included).

---

### 8) Useful CLI and Scripts
- Push schema: `node scripts/push-schema.js --api-id=<APPSYNC_API_ID>`
- Deploy assistant: `pwsh -File scripts/agent/deploy.ps1 ...`
- Mobile package script: from `mobile/`, `npm run push:schema` (uses the same push script)

---

### 9) Troubleshooting
- Message metadata is null in mobile:
  - Ensure AppSync permissions allow reading `Message.metadata`. See `_docs/2_INPROCESS/Option2_AppSyncMetadataPermissionsFix.md`.
- Assistant replies don’t post:
  - Lambda role needs `appsync:GraphQL` for your API. Deploy script sets this policy.
  - Verify `APPSYNC_ENDPOINT` is correct for both Lambda and mobile.
- Expo push token missing:
  - Expo Go doesn’t register remote tokens; use a dev client or standalone build.
- Mobile cannot authenticate:
  - Verify Cognito IDs/region in `mobile/.env`. Ensure the Identity Pool trusts the User Pool.

---

### 10) Quick Start Checklist
1) Create AppSync API and push `schema.graphql`.
2) Create Cognito User Pool + App Client + Identity Pool.
3) Create `mobile/.env` with Cognito + AppSync values (and flags).
4) Deploy Assistant Lambda and set `ASSISTANT_ENDPOINT`.
5) Run the app with `npx expo start`. Sign up/sign in and open the Assistant conversation.

---

### 11) Reference Docs
- `README.md` – project overview and commands
- `_docs/6_MVP_COMPLETE/assistant_mvp_overview.md` – assistant behavior and flags
- `_docs/6_MVP_COMPLETE/mvp_architecture.md` – architecture diagram and notes
- `_docs/appsync/README.md` – attaching `UserProfile` resolvers
- `_docs/2_INPROCESS/Option2_AppSyncMetadataPermissionsFix.md` – metadata field auth guidance

---

### 12) Team Conventions
- Keep your AWS profile and region explicit during local runs to avoid cross-account mistakes.
- Do not commit secrets. Use AWS Secrets Manager for the OpenAI key in Lambda.
- Prefer feature flags via `.env` so testers can toggle behavior quickly.
